<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open Card Sort (Unlabeled Piles)</title>

  <style>
    :root { --gap:14px; --purple:#a78bfa; --purple-text:#3b2f66; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color:#222; }
    /* Header row */
    .header { display:grid; grid-template-columns: 1fr auto; gap: var(--gap); align-items:start; margin-bottom: 8px; }
    h1 { font-size: 20px; margin: 0 0 8px 0; }
    .instructions { color:#444; font-size: 16px; margin: 0; max-width: 900px; }
    .finishBtn {
      padding: 10px 14px; border-radius: 10px; border: 1px solid #d9d2ff;
      background: var(--purple); color: white; font-weight: 600; cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.05);
    }
    .finishBtn:hover { filter: brightness(0.95); }
    .finishBtn:disabled { opacity: .6; cursor: default; }

    /* All cards panel */
    .panel { background:#f8f9fb; border:1px solid #e6e7eb; border-radius: 12px; padding: 12px; }
    .panel h2 { font-size: 14px; margin: 0 0 8px 0; }
    .allgrid { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .list { min-height: 220px; background: #fff; border:1px dashed #d4d7dd; border-radius:10px; padding:10px; }
    .card { padding: 8px; margin: 6px 0; background: white; border: 1px solid #ddd; border-radius: 8px; cursor: grab; }

    /* Piles area */
    .controlsRow { display:flex; gap:10px; align-items:center; margin: 14px 0 8px; }
    .addBtn, .delBtn {
      padding: 8px 12px; border-radius: 10px; border:1px solid #ccc; background:#fff; cursor:pointer;
    }
    .addBtn:hover, .delBtn:hover { background:#f4f4f4; }

/* Piles: horizontal row, scroll sideways if they overflow */
.pilesGrid {
  display: flex;
  flex-direction: row;
  gap: var(--gap);
  overflow-x: auto;      /* allows horizontal scrolling if piles don’t fit */
  padding-bottom: 10px;  /* breathing room under piles */
}

/* Make each pile a fixed card-like width */
.pile {
  flex: 0 0 280px;       /* each pile is ~280px wide, doesn’t stretch */
  background:#fafafa;
  border:1px solid #e6e7eb;
  border-radius:12px;
  padding:10px;
  min-height: 160px;
}
    .pileHeader { display:flex; align-items:center; }
    .pileLabel { font-weight:600; font-size: 13px; }
    .spacer { flex:1; }
    .pileList { min-height: 140px; background:#fff; border:1px dashed #d4d7dd; border-radius:10px; padding:10px; margin-top:8px; }

    /* Exclude bin at bottom */
    .exclude { background:#fff6f6; border:1px solid #f5c8c8; border-radius:12px; padding:10px; }
    .exclude h3 { margin:0 0 8px 0; font-size:14px; color:#a33; }
    .hint { font-size:12px; color:#666; }

    /* Small screens */
    @media (max-width:700px){
      .allgrid { grid-template-columns: 1fr; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
  <!-- Header with instructions (left) and Finish (right) -->
  <div class="header">
    <div>
      <h1>Sort the cards into as many piles as you wish</h1>
      <p class="instructions">
        On these cards you will find descriptions of different goals and plans that one can have and find important in life.
        Please read each of these cards carefully and sort the cards into several piles with respect to how important these
        goals and plans are for you personally. Again, please begin on the left side with the pile of those goals and plans
        which are most important to you. Please order those goals and plans that are less important or not important at all
        to you into piles on the right side. You may build as many piles as you think necessary.
      </p>
    </div>
    <div style="text-align:right;">
      <button id="finishBtn" class="finishBtn">Finish &amp; continue</button>
      <div class="hint">We’ll save your piles and return you to the survey.</div>
    </div>
  </div>

  <!-- All cards panel (two columns spanning full width) -->
  <div class="panel" style="margin-bottom:14px;">
    <h2>All cards</h2>
    <div class="allgrid">
      <div id="allA" class="list"></div>
      <div id="allB" class="list"></div>
    </div>
    <p class="hint" style="margin-top:8px;">Drag cards from here into your piles below.</p>
  </div>

  <!-- Controls and piles (start with one pile on the left) -->
  <div class="controlsRow">
    <button id="addPileBtn" class="addBtn">+ Add pile</button>
    <span class="hint">Create more piles and drag cards between them.</span>
  </div>

  <div id="pilesGrid" class="pilesGrid"></div>

  <!-- Exclude bin at the bottom -->
  <div class="exclude" style="margin-top:16px;">
    <h3>Exclude (discard)</h3>
    <div id="exclude" class="list"></div>
    <p class="hint">Drop here to exclude a card from your piles.</p>
  </div>

  <script>
    // =========================
    // CONFIG — EDIT THESE
    // =========================
    const CARDS = [
      "Have strong power of discernment",          // 1
      "Not depend on someone else’s feelings",     // 2
      "Determine my future by myself",             // 3
      "Be autonomous in my feelings",              // 4
      "Receive approval for my work",              // 5
      "Have good friends who accept me the way I am", // 6
      "Be with people who set high value on my opinion", // 7
      "Have close friends who trust me",           // 8
      "Be able to confide in a close friend at any time", // 10
      "Receive good advice on important decision", // 11
      "Not feel lonely",                           // 12
      "Leave my mark on this world",               // 13
      "Be available to others who need to be comforted", // 14
      "Give my knowledge/experience on to others", // 15
      "Help others to find their purpose in life", // 16
      "Have large experience of life",             // 17
      "Know myself and my feelings very well",     // 18
      "Be well educated and knowledgeable",        // 19
      "Have control over my feelings",             // 20
    ];


    // Optional enforcement
    const REQUIRE_ALL_PLACED = false;

    // Qualtrics/parent origin for postMessage security:
    const targetOrigin = "https://nyu.qualtrics.com"; // ← EDIT ME (use your survey’s domain)

    // =========================
    // IDs from query string (optional)
    // =========================
    const qs = new URLSearchParams(location.search);
    const prolificId = qs.get("pid") || "";
    const responseId = qs.get("rid") || "";

    // =========================
    // Build All-cards (two lists) and Exclude
    // =========================
    const allA = document.getElementById("allA");
    const allB = document.getElementById("allB");
    const excludeList = document.getElementById("exclude");
    const pilesGrid = document.getElementById("pilesGrid");
    let pileCounter = 0;

    function makeCard(text) {
      const el = document.createElement("div");
      el.className = "card";
      el.dataset.card = text;
      el.textContent = text;
      return el;
    }
    // Distribute cards across the two All lists for a natural two-column layout
    CARDS.forEach((c, i) => (i % 2 === 0 ? allA : allB).appendChild(makeCard(c)));

    const listOptions = { group: "cards", animation: 150, ghostClass: "dragGhost" };
    new Sortable(allA, listOptions);
    new Sortable(allB, listOptions);
    new Sortable(excludeList, listOptions);

    // =========================
    // Piles (unlabeled)
    // =========================
    function createPile() {
      pileCounter++;
      const pileId = "pile_" + pileCounter;

      const wrap = document.createElement("div");
      wrap.className = "pile";

      const header = document.createElement("div");
      header.className = "pileHeader";

      const label = document.createElement("div");
      label.className = "pileLabel";
      label.textContent = "Pile " + pileCounter;

      const spacer = document.createElement("div");
      spacer.className = "spacer";

      const delBtn = document.createElement("button");
      delBtn.className = "delBtn";
      delBtn.textContent = "Delete pile";

      const list = document.createElement("div");
      list.className = "pileList";
      list.id = pileId;

      header.appendChild(label);
      header.appendChild(spacer);
      header.appendChild(delBtn);
      wrap.appendChild(header);
      wrap.appendChild(list);
      pilesGrid.appendChild(wrap);

      new Sortable(list, listOptions);

      delBtn.addEventListener("click", () => {
        const hasCards = list.children.length > 0;
        if (hasCards && !confirm("This pile has cards. Delete anyway? Cards will move back to All cards.")) return;
        // Move any cards back to All (alternate columns)
        Array.from(list.children).forEach((ch, i) => (i % 2 === 0 ? allA : allB).appendChild(ch));
        wrap.remove();
        renumberPiles();
      });

      return pileId;
    }

    function renumberPiles() {
      const piles = Array.from(pilesGrid.children);
      pileCounter = 0;
      piles.forEach(p => {
        pileCounter++;
        p.querySelector(".pileLabel").textContent = "Pile " + pileCounter;
      });
    }

    // Start with exactly ONE pile
    createPile();

    document.getElementById("addPileBtn").addEventListener("click", () => createPile());

    // =========================
    // Data helpers
    // =========================
    function readList(el) {
      return Array.from(el.children).map(ch => ch.dataset.card);
    }
    function getAllUnplaced() {
      return readList(allA).concat(readList(allB));
    }
    function getPilesData() {
      return Array.from(pilesGrid.children).map((pileEl, idx) => {
        const listDiv = pileEl.querySelector(".pileList");
        return { id: listDiv.id, index: idx + 1, cards: readList(listDiv) };
      });
    }
    function getResults() {
      return {
        meta: {
          prolificId,
          responseId,
          startedAt: window.__startedAt || new Date().toISOString(),
          finishedAt: new Date().toISOString(),
          userAgent: navigator.userAgent
        },
        allCards: CARDS.slice(),
        piles: getPilesData(),
        exclude: readList(excludeList),
        unplaced: getAllUnplaced()
      };
    }
    window.__startedAt = new Date().toISOString();

    function validate(results) {
      if (REQUIRE_ALL_PLACED && results.unplaced.length > 0) {
        alert("Please sort all cards into piles or Exclude before continuing.");
        return false;
      }
      return true;
    }

    // =========================
    // Finish → postMessage to Qualtrics
    // =========================
    const finishBtn = document.getElementById("finishBtn");
    finishBtn.addEventListener("click", () => {
      const results = getResults();
      if (!validate(results)) return;

      window.parent.postMessage({ type: "cardsort_done", payload: results }, targetOrigin);
      finishBtn.disabled = true;
      finishBtn.textContent = "Saving…";
      setTimeout(() => { finishBtn.textContent = "You can close this tab if nothing happens."; }, 2000);
    });
  </script>
</body>
</html>
